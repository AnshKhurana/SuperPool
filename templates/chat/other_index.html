{% extends 'base.html' %}
{% load static %}

{% block title %}Service-Chat Window{% endblock %}
{% block header_text %}&nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp My Services{% endblock %}

{% block content %}
<!--<link rel="stylesheet" href="{% static 'css/chat_style.css' %}" type="text/css" media="screen" />-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<!--    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">-->
<!--    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lobster">-->
<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">-->
<!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
<script src="{% static 'js/jquery-1.12.2.min.js' %}" type="text/javascript"></script>
	<script src="{% static 'js/reconnecting-websocket.min.js' %}" type="text/javascript"></script>
<!--{% include 'includes/stylesheets.html' %}-->

<body id="body-class">
        <div class="gap gray-bg">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="row" id="page-contents">
                            {% include 'includes/sidebar.html' %}
                            <div class="col-lg-6">
                                <div class="central-meta">


                                    <div class="frnds">
                                        <ul class="nav nav-tabs">
                                            {#                                            <h5 class="f-title"><i class="ti-user"></i>My Services </h5>#}
                                            <li class="nav-item"><a class="active" href="#frends" data-toggle="tab">My Services</a></li>
                                        </ul>

                                         <div id="chats"></div>

                                        <div id="list" class="tab-content">
                                            <div class="tab-pane active fade show ">
                                                <ul class="nearby-contct"  id="service_list">



                                                    {#                                                        INSERT HERE#}

                                                    {% for service in services %}
                                                    <li class="service-link" data-service-id="{{ service.id }}">
                                                        <div class='nearly-pepls'>
                                                            <div class="pepl-info">
                                                                <h4><a href="#" title=\"\"> {{ service.category }} </a></h4>
<!--                                                                 <a href="#" title=""><h5>" {{ service.transport }} "</h5></a>-->
                                                                <p> by {{ service.initiator }} </p>
<!--                                                                <h4>Source: {{ service.start_point }}<br> Destination: {{ service.end_point }}</h4> <br>-->
                                                                <h4><p>Start Time: {{ service.start_time }} <br> End Time: {{ service.end_time }}</p></h4>
                                                                <span> {{ service.description }} </span>
<!--                                                                <a href="#" title="" data-url="{% url 'groups:create' %}" class="add-butn add-friend" data-ripple="">Already a member</a>-->
                                                                {% if service.is_active == True %}
                                                                    <button onclick="disable({{ service.id }})">Disable</button>
                                                                <button class="service-link" data-service-id="{{ service.id }}" onclick="join_chat()">Join Chat</button><br><br>
                                                                {% else %}
                                                                    <button onclick="disable({{ service.id }})">Enable</button>
                                                                <button class="service-link" data-service-id="{{ service.id }}" onclick="join_chat()">Join Chat</button><br><br>
                                                                {% endif %}
                                                                <br>
<!--                                                                <button class="service-link" data-service-id="{{ service.id }}">Join Chat</button><br><br>-->
                                                            </div>
                                                        </div>
                                                    </li>
                            <!--                        </li> &nbsp &nbsp &nbsp-->
                                                <script>console.log('{{ service.is_active }}');</script>



                                                {% endfor %}

                                                    {% for service in other_serv %}
                                                    <li class="service-link" data-service-id="{{ service.id }}">
                                                        <div class='nearly-pepls'>
                                                            <div class="pepl-info">
                                                                <h4><a href="#" title=\"\"> {{ service.category }} </a></h4>
<!--                                                                 <a href="#" title=""><h5>" {{ service.transport }} "</h5></a>-->
                                                                <p> by {{ service.initiator }} </p>
<!--                                                                <h4>Source: {{ service.start_point }}<br> Destination: {{ service.end_point }}</h4> <br>-->
                                                                <h4><p>Start Time: {{ service.start_time }} <br> End Time: {{ service.end_time }}</p></h4>
                                                                <span> {{ service.description }} </span>
<!--                                                                <a href="#" title="" data-url="{% url 'groups:create' %}" class="add-butn add-friend" data-ripple="">Already a member</a>-->
                                                                {% if service.is_active == True %}
                                                                    <button onclick="disable({{ service.id }})">Disable</button>
                                                                <button class="service-link" data-service-id="{{ service.id }}" onclick="join_chat()">Join Chat</button><br><br>
                                                                {% else %}
                                                                    <button onclick="disable({{ service.id }})">Enable</button>
                                                                <button class="service-link" data-service-id="{{ service.id }}" onclick="join_chat()">Join Chat</button><br><br>
                                                                {% endif %}
                                                                <br>
<!--                                                                <button class="service-link" data-service-id="{{ service.id }}">Join Chat</button><br><br>-->
                                                            </div>
                                                        </div>
                                                    </li>
                            <!--                        </li> &nbsp &nbsp &nbsp-->
                                                <script>console.log('{{ service.is_active }}');</script>

                                                {% endfor %}
                                                </ul>

                                                <div class="lodmore">
                                                    {#                                                    set action of this button to refresh page or select fetchAll#}
                                                    <button onclick="#" class="btn-view btn-load-more"></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>



                                </div>

                            </div><!-- centerl meta -->
                             <div class="col-lg-3">
<!--                                 <div class="col-lg-3">-->
                                <aside class="sidebar static">

                                    {#                                    checkboxes for categories#}
                                    <div class="widget">
                                        <h4 class="widget-title">Categories</h4>
                                        <ul class="followers">
                                            <li>
                                                <div class="friend-meta">
                                                    <h4><input type="radio" id=food_sel" name="category" value="food" onclick="window.location.href='/'"> Food</h4>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="friend-meta">
                                                    <h4><input type="radio" id="travel_sel" name="category" value="travel"  onclick="window.location.href='travel'"> Travel</h4>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="friend-meta">
                                                    <h4><input type="radio" id="shopping_sel" name="category" value="shopping"  onclick="window.location.href='shopping'" > Shopping</h4>
                                                </div>
                                            </li>

                                            <li>
                                                <div class="friend-meta">
                                                    <h4><input type="radio" id="event_sel" name="category" value="event"  onclick="window.location.href='event'" > Event</h4>
                                                </div>
                                            </li>

                                            <li>
                                                <div class="friend-meta">
                                                    <h4><input type="radio" id="other_sel" name="category" value="other" checked onclick="window.location.href='other'" > Other</h4>
                                                </div>
                                            </li>
                                        </ul>

                                <br><br>

                                    <div class="widget friend-list stick-widget">
                                        <div id="category"></div>
                                    </div>
                                    <div class="widget friend-list stick-widget">
                                        <div id="time"></div>
                                    </div>
                                    <div class="widget friend-list stick-widget">
                                        <div id="people"></div>
                                    </div>
                                    </aside>
                            </div><!-- sidebar -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
<script>
$(function () {
            // Correctly decide between ws:// and wss://
            var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
            var ws_path = ws_scheme + '://' + window.location.host + "/chat/stream/";
            console.log("Connecting to " + ws_path);
            var socket = new ReconnectingWebSocket(ws_path);
            console.log(socket);

            // Handle incoming messages
            socket.onmessage = function (message) {
                // Decode the JSON
                console.log(message);
                console.log("Got websocket message " + message.data);
                var data = JSON.parse(message.data);
                // Handle errors
                if (data.error) {
                    alert(data.error);
                    return;
                }
                // Handle joining
                if (data.join) {
                    console.log("Joining service " + data.join);
                    console.log(data);
                    var servicediv = $(
                            "<div class='service' id='service-" + data.join + "'>" +
                            "<h2> Description: " + data.description + "</h2>" +
                            "<div class='messages'></div>" +
                            "<form><input placeholder='  Type here    .....'><button ><i class='fa fa-paper-plane'></i></button></form>" +
                            "</div>"
                    );
                    // Hook up send button to send a message
                    servicediv.find("form").on("submit", function () {
                        socket.send(JSON.stringify({
                            "command": "send",
                            "service": data.join,
                            "message": servicediv.find("input").val()
                        }));
                        servicediv.find("input").val("");
                        return false;
                    });

                    var category_html =   "<h4 class=\"widget-title\">Category</h4>" +
                                        "<div id=\"searchDir\"></div>" +
                                        "<span class=\"status f-online\"></span>" +
                                        "<h6>" + data.category + "</h6>";

                    var time_html =      "<h4 class=\"widget-title\">Start Time</h4>" +
                                        "<div id=\"searchDir\"></div>" +
                                        "<span>" + data.start_time + "</span>" +
                                        "<h4 class=\"widget-title\">End Time</h4>" +
                                        "<div id=\"searchDir\"></div>" +
                                        "<span>" + data.end_time + "</span>";

                    var people_html =   "<h4 class=\"widget-title\">Initiator</h4>" +
                                        "<div id=\"searchDir\"></div>" +
                                        "<span>" + data.initiator + "</span><br>" +
                                        "<h4 class=\"widget-title\">Members</h4>";
                                           // {#                                            {% for friend in friends %}#}
                                           // {#                                                <li>#}
                                           // {#                                                    <figure>#}
                                           // {#                                                        <img src="images/resources/friend-avatar.jpg" alt="">#}
                                           // {#                                                        <span class="status f-online"></span>#}
                                           // {#                                                    </figure>#}
                      //
                        //                    {#                                            {% endfor %}#}
                        //                "</ul>";

                     for(val in data.members){
                        people_html +="<span>" + data.members[val]+ "</span><br>";
                     }
                    // console.log(members);
                    $("#body-class").append("<link rel=\"stylesheet\" href=\"{% static 'css/chat_style.css' %}\" type=\"text/css\" media=\"screen\" />");
                    $("#chats").append(servicediv);
                    $("#list").html("");
                    //$("#category").html(category_html);
                    $("#time").html(time_html);
                    $("#people").html(people_html);
                    // Handle leaving
                } else if (data.leave) {
                    console.log("Leaving service " + data.leave);
                    $("#service-" + data.leave).remove();
                    // Handle getting a message
                } else if (data.message || data.msg_type != 0) {
                    var msgdiv = $("#service-" + data.service + " .messages");
                    var ok_msg = "";
                    // msg types are defined in chat/settings.py
                    // Only for demo purposes is hardcoded, in production scenarios, consider call a service.
                    switch (data.msg_type) {
                        case 0:
                            // Message
                            if (data.login_user == data.username) {
                            ok_msg = "<div class='chat-message-me sb1'>" +
                                    //"<span class='username'>" + data.username + "</span><br>" +
                                    "<span class='body'>" + data.message + "</span><br>" +
                                    // "&nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp " +
                                    "<span class='date'>" + data.timestamp + "</span>" +
                                    "</div><br>";

                            //ok_msg = "<li style=' direction: rtl; text-align: right;'>"+
                            //    "<figure><img src='images/resources/userlist-1.jpg' alt=''></figure>" +
                            //    "<p style='margin-left: 0; margin-right: 10px; text-align: left; direction: ltr;'>" + data.message + "</p></li>";
                            }
                            else {
                            ok_msg = "<div class='chat-message-other sb2'>" +
                                    "<span class='username'>" + data.username + ":</span><br>" +
                                    "<span class='body'>" + data.message + "</span><br>" +
                                    "<span class='date'>" + data.timestamp + "</span>" +
                                    "</div><br>";
                            }
                            break;
                        case 1:
                            // Warning / Advice messages
                            ok_msg = "<div class='contextual-message text-warning'>" + data.message +
                                    "</div>";
                            break;
                        case 2:
                            // Alert / Danger messages
                            ok_msg = "<div class='contextual-message text-danger'>" + data.message +
                                    "</div>";
                            break;
                        case 3:
                            // "Muted" messages
                            ok_msg = "<div class='contextual-message text-muted'>" + data.message +
                                    "</div>";
                            break;
                        case 4:
                            // User joined service
                            ok_msg = "<div class='contextual-message text-muted'>" + data.username +
                                    " is online!" +
                                    "</div>";
                            break;
                        case 5:
                            // User left service
                            ok_msg = "<div class='contextual-message text-muted'>" + data.username +
                                    " went offline!" +
                                    "</div>";
                            break;
                        default:
                            console.log("Unsupported message type!");
                            return;
                    }
                    msgdiv.append(ok_msg);

                    msgdiv.scrollTop(msgdiv.prop("scrollHeight"));
                } else {
                    console.log("Cannot handle message!");
                }
            };

            // Says if we joined a service or not by if there's a div for it
            inservice = function (serviceId) {
                return $("#service-" + serviceId).length > 0;
            };

            // service join/leave
    $( "button" ).click(function () {
                serviceId = $(this).attr("data-service-id");
                if (inservice(serviceId)) {
                    // Leave service
                    $(this).removeClass("joined");
                    socket.send(JSON.stringify({
                        "command": "leave",
                        "service": serviceId
                    }));
                } else {
                    // Join service
                    $(this).addClass("joined");
                    socket.send(JSON.stringify({
                        "command": "join",
                        "service": serviceId
                    }));
                }
            });
            // Helpful debugging
            socket.onopen = function () {
                console.log("Connected to chat socket");
            };
            socket.onclose = function () {
                console.log("Disconnected from chat socket");
            }
        });
</script>
</body>
{% endblock %}


{% block extra_body %}
    <script>




    </script>
{% endblock %}









